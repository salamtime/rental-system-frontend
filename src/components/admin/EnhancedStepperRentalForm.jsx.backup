import React, { useState, useEffect, useRef, useCallback } from 'react';
import { 
  User, Car, CreditCard, Check, ChevronRight, Scan, 
  UserSearch, AlertCircle, Loader, Clock, DollarSign, 
  Calculator, Info, RefreshCw, Shield, Phone, Mail,
  Calendar, MapPin, FileText, CreditCard as CreditCardIcon
} from 'lucide-react';
import { supabase } from '../../lib/supabase';
import EnhancedUnifiedIDScanModal from '../customers/EnhancedUnifiedIDScanModal';
import TransactionalRentalService from '../../services/TransactionalRentalService';
import SmartVehicleSelector from '../SmartVehicleSelector';
import SmartDatePicker from '../SmartDatePicker';
import VehicleModelService from '../../services/VehicleModelService';
import AppSettingsService from '../../services/AppSettingsService';
import enhancedUnifiedCustomerService from '../../services/EnhancedUnifiedCustomerService';
import { useAuth } from '../../contexts/AuthContext';
import { 
  getMoroccoTodayString, 
  getMoroccoDateOffset, 
  getMoroccoHourlyTimes,
  isAfter, 
  parseDateAsLocal, 
  formatDateToYYYYMMDD 
} from '../../utils/moroccoTime';
import { toast } from 'sonner';

const EnhancedStepperRentalForm = ({ onSubmit, initialData = null, isLoading = false, onCancel }) => {
  const [currentStep, setCurrentStep] = useState(1);
  const [showIDScanModal, setShowIDScanModal] = useState(false);
  const [scannedCustomerData, setScannedCustomerData] = useState(null);
  const [submitting, setSubmitting] = useState(false);
  const { userProfile } = useAuth();

  // Form state - COMPLETE from AvailabilityAwareRentalForm
  const [formData, setFormData] = useState({
    customer_name: '',
    customer_email: '',
    customer_phone: '',
    customer_id: null,
    vehicle_id: '',
    rental_start_date: '',
    rental_end_date: '',
    rental_start_time: '',
    rental_end_time: '',
    rental_type: 'daily',
    rental_status: 'scheduled',
    payment_status: 'unpaid',
    total_amount: 0,
    pickup_location: 'Office',
    dropoff_location: 'Office',
    quantity_days: 0,
    unit_price: 0,
    transport_fee: 0,
    pickup_transport: false,
    dropoff_transport: false,
    deposit_amount: 0,
    damage_deposit: 0,
    remaining_amount: 0,
    customer_licence_number: '',
    customer_id_number: '',
    customer_dob: '',
    customer_place_of_birth: '',
    customer_nationality: '',
    customer_issue_date: '',
    contract_signed: false,
    insurance_included: true,
    helmet_included: true,
    gear_included: false,
    accessories: '',
    signature_url: null,
    second_driver_name: '',
    second_driver_license: '',
    second_driver_id_image: null,
    customer_id_image: null,
    approval_status: 'auto',
    pending_total_request: null
  });

  const [errors, setErrors] = useState({});
  const [success, setSuccess] = useState(null);
  const [dateError, setDateError] = useState(null);
  const [debugInfo, setDebugInfo] = useState(null);
  const [vehicleModels, setVehicleModels] = useState([]);
  const [transportFees, setTransportFees] = useState({
    pickup_fee: 0,
    dropoff_fee: 0
  });
  const [availabilityStatus, setAvailabilityStatus] = useState('unknown');
  const [availabilityDetails, setAvailabilityDetails] = useState(null);
  const [canSubmit, setCanSubmit] = useState(false);
  const [autoCalculatedPrice, setAutoCalculatedPrice] = useState(0);
  const isManualStatusChange = useRef(false);

  const [customers, setCustomers] = useState([]);
  const [rentals, setRentals] = useState([]);
  const [isPhoneDirty, setIsPhoneDirty] = useState(false);
  const [isEmailDirty, setIsEmailDirty] = useState(false);
  const [suggestions, setSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const customerSearchRef = useRef(null);
  const isProgrammaticChange = useRef(false);

  // === CRITICAL FUNCTIONS from AvailabilityAwareRentalForm ===

  // 1. composeDateTime - EXACT COPY
  const composeDateTime = (date, time) => {
    if (!date) {
      return null;
    }
    const localDate = parseDateAsLocal(date);
    if (!localDate || isNaN(localDate.getTime())) {
        console.error('Composed invalid date from string:', date);
        return null;
    }

    const timeToUse = time || '00:00';
    const [hours, minutes] = timeToUse.split(':').map(Number);
    
    if (isNaN(hours) || isNaN(minutes)) {
        console.error('Invalid time format:', timeToUse);
        localDate.setHours(0, 0, 0, 0);
        return localDate;
    }

    localDate.setHours(hours, minutes, 0, 0);
    
    if (isNaN(localDate.getTime())) {
        console.error('Composed invalid date with time:', date, time);
        return null;
    }
    return localDate;
  };

  // 2. getDirectPricing - EXACT COPY
  const getDirectPricing = (vehicleId, rentalType) => {
    console.log('ðŸ’° Direct pricing lookup for:', { vehicleId, rentalType });
    
    if (!vehicleId || !rentalType) {
      console.log('âš ï¸ Invalid inputs for pricing lookup:', { vehicleId, rentalType });
      return 0;
    }
    
    const pricingMap = {
      '9': { hourly: 400, daily: 1500, weekly: 5000 },
      '10': { hourly: 600, daily: 1800, weekly: 10000 },
      '11': { hourly: 1000, daily: 3800, weekly: 15000 },
      '1': { hourly: 400, daily: 1500, weekly: 5000 },
      '2': { hourly: 400, daily: 1500, weekly: 5000 },
      '3': { hourly: 600, daily: 1800, weekly: 10000 },
      '4': { hourly: 600, daily: 1800, weekly: 10000 },
      '5': { hourly: 1000, daily: 3800, weekly: 15000 },
      '6': { hourly: 1000, daily: 3800, weekly: 15000 },
      '7': { hourly: 400, daily: 1500, weekly: 5000 },
      '8': { hourly: 600, daily: 1800, weekly: 10000 },
      '12': { hourly: 1000, daily: 3800, weekly: 15000 },
      '13': { hourly: 400, daily: 1500, weekly: 5000 },
      '14': { hourly: 600, daily: 1800, weekly: 10000 },
      '15': { hourly: 1000, daily: 3800, weekly: 15000 },
      '23': { hourly: 400, daily: 1500, weekly: 5000 }
    };

    const vehiclePricing = pricingMap[vehicleId.toString()];
    if (!vehiclePricing) {
      console.log('âš ï¸ No pricing found for vehicle ID:', vehicleId);
      return rentalType === 'hourly' ? 400 : rentalType === 'daily' ? 1500 : 5000;
    }

    const price = vehiclePricing[rentalType] || 0;
    console.log('âœ… Found price:', price, 'MAD for vehicle', vehicleId, 'rental type', rentalType);
    return price;
  };

  // 3. autoPopulateUnitPrice - EXACT COPY
  const autoPopulateUnitPrice = () => {
    try {
      console.log('ðŸ’° Starting auto-populate unit price...');
      
      if (!formData.vehicle_id || !formData.rental_type) {
        console.log('âš ï¸ Missing vehicle or rental type, keeping unit price at 0');
        return;
      }

      const unitPrice = getDirectPricing(formData.vehicle_id, formData.rental_type);

      console.log('ðŸ’° Retrieved unit price:', unitPrice);

      // Store the auto-calculated price for later comparison
      setAutoCalculatedPrice(unitPrice);

      setFormData(prev => ({
        ...prev,
        unit_price: unitPrice
      }));

      if (unitPrice > 0) {
        console.log('âœ… Unit price auto-populated successfully:', unitPrice);
      } else {
        console.log('âš ï¸ No pricing found or price is 0');
      }
    } catch (err) {
      console.error('âŒ Error auto-populating unit price:', err);
    }
  };

  // 4. calculateTransportFee - EXACT COPY
  const calculateTransportFee = () => {
    let totalTransportFee = 0;
    
    if (formData.pickup_transport) {
      totalTransportFee += transportFees.pickup_fee || 0;
    }
    
    if (formData.dropoff_transport) {
      totalTransportFee += transportFees.dropoff_fee || 0;
    }
    
    setFormData(prev => ({
      ...prev,
      transport_fee: totalTransportFee
    }));
  };

  // 5. calculateFinancials - EXACT COPY
  const calculateFinancials = () => {
    const subtotal = (formData.quantity_days || 0) * (formData.unit_price || 0);
    const total = subtotal + (formData.transport_fee || 0);
    const remaining = total - (formData.deposit_amount || 0);

    console.log('ðŸ’° Financial calculation:', {
      subtotal: subtotal,
      transport_fee: formData.transport_fee,
      total: total,
      deposit_amount: formData.deposit_amount,
      damage_deposit: formData.damage_deposit,
      remaining: remaining
    });

    setFormData(prev => ({
      ...prev,
      total_amount: total,
      remaining_amount: Math.max(remaining, 0)
    }));
  };

  // 6. calculateQuantityAndPricing - EXACT COPY
  const calculateQuantityAndPricing = () => {
    const { rental_type, rental_start_date, rental_end_date, rental_start_time, rental_end_time, vehicle_id } = formData;

    if (!rental_start_date || !rental_end_date) return;

    let startDatetime = composeDateTime(rental_start_date, rental_start_time);
    let endDatetime = composeDateTime(rental_end_date, rental_end_time);

    if (!startDatetime || !endDatetime || isAfter(startDatetime, endDatetime)) return;

    let updatedEndDate = rental_end_date;
    let isOvernight = false;

    if (rental_type === 'hourly' && endDatetime < startDatetime) {
      const correctedEndDate = new Date(endDatetime);
      correctedEndDate.setDate(correctedEndDate.getDate() + 1);
      endDatetime = correctedEndDate;
      updatedEndDate = formatDateToYYYYMMDD(correctedEndDate);
      isOvernight = true;
      console.log('ðŸ•’ Overnight hourly rental detected. Corrected end date:', updatedEndDate);
    }

    let quantity = 0;
    if (rental_type === 'hourly') {
      const diffHours = (endDatetime - startDatetime) / (1000 * 60 * 60);
      quantity = Math.ceil(Math.max(diffHours, 1));
    } else if (rental_type === 'weekly') {
      const diffDays = Math.max(Math.ceil((endDatetime - startDatetime) / (1000 * 60 * 60 * 24)), 1);
      quantity = Math.ceil(diffDays / 7);
    } else {
      const startDate = parseDateAsLocal(rental_start_date);
      const endDate = parseDateAsLocal(updatedEndDate);
      if (!startDate || !endDate) return;
      const diffDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
      quantity = Math.max(diffDays, 1);
    }

    console.log('ðŸ“Š Calculated quantity:', quantity, 'for rental type:', rental_type);

    if (isOvernight || formData.quantity_days !== quantity) {
        setFormData(prev => ({
          ...prev,
          quantity_days: quantity,
          ...(isOvernight && { rental_end_date: updatedEndDate }),
        }));
    }
    
    if (vehicle_id) {
      autoPopulateUnitPrice();
    }
  };

  // 7. sendWhatsAppNotifications - EXACT COPY
  const sendWhatsAppNotifications = async (pendingTotalRequest) => {
    try {
      console.log('ðŸ“± WHATSAPP: Fetching admins with WhatsApp enabled...');
      
      const { data: admins, error } = await supabase
        .from('app_b30c02e74da644baad4668e3587d86b1_users')
        .select('id, full_name, phone_number, whatsapp_notifications, role')
        .in('role', ['owner', 'admin'])
        .eq('whatsapp_notifications', true)
        .not('phone_number', 'is', null);

      if (error) {
        console.error('ðŸ“± WHATSAPP: Error fetching admins:', error);
        return 0;
      }

      if (!admins || admins.length === 0) {
        console.log('ðŸ“± WHATSAPP: No admins with WhatsApp enabled found');
        return 0;
      }

      console.log(`ðŸ“± WHATSAPP: Found ${admins.length} admin(s) with WhatsApp enabled:`, admins);

      let notificationCount = 0;
      
      for (const admin of admins) {
        try {
          let cleanPhone = admin.phone_number.replace(/[^\d+]/g, '');
          
          if (!cleanPhone.startsWith('+')) {
            cleanPhone = '+212' + cleanPhone.replace(/^0+/, '');
          }

          const message = encodeURIComponent(
            `ðŸš¨ Approval Required for Rental\n\n` +
            `Price Override Request: ${pendingTotalRequest} MAD\n\n` +
            `Please review and approve/decline this rental.\n\n` +
            `Link: ${window.location.origin}/admin/rentals`
          );

          const whatsappUrl = `https://wa.me/${cleanPhone}?text=${message}`;

          console.log(`ðŸ“± WHATSAPP: Opening WhatsApp for ${admin.full_name} (${admin.phone_number})`);

          window.open(whatsappUrl, '_blank');
          
          notificationCount++;

          if (notificationCount < admins.length) {
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        } catch (err) {
          console.error(`ðŸ“± WHATSAPP: Error sending notification to ${admin.full_name}:`, err);
        }
      }

      console.log(`ðŸ“± WHATSAPP: Successfully triggered ${notificationCount} notification(s)`);
      return notificationCount;

    } catch (err) {
      console.error('ðŸ“± WHATSAPP: Error in sendWhatsAppNotifications:', err);
      return 0;
    }
  };

  // 8. generateCustomerId - EXACT COPY
  const generateCustomerId = () => {
    const timestamp = Date.now();
    const randomString = Math.random().toString(36).substring(2, 11);
    return `cust_${timestamp}_${randomString}`;
  };

  // 9. getAggregatedCustomerData - EXACT COPY
  const getAggregatedCustomerData = useCallback(() => {
    const customerMap = new Map();
    customers.forEach(c => {
        if (c.full_name) {
            const key = c.full_name.trim().toLowerCase();
            if (!customerMap.has(key)) {
                customerMap.set(key, {
                    id: c.id,
                    name: c.full_name,
                    email: c.email,
                    phone: c.phone,
                    licence_number: c.licence_number,
                    source: 'customer'
                });
            }
        }
    });
    rentals.forEach(r => {
        if (r.customer_name) {
            const key = r.customer_name.trim().toLowerCase();
            const existing = customerMap.get(key);
            if (existing) {
                if (!existing.email && r.customer_email) existing.email = r.customer_email;
                if (!existing.phone && r.customer_phone) existing.phone = r.customer_phone;
                if (!existing.licence_number && r.customer_licence_number) existing.licence_number = r.customer_licence_number;
            } else {
                customerMap.set(key, {
                    id: r.customer_id,
                    name: r.customer_name,
                    email: r.customer_email,
                    phone: r.customer_phone,
                    licence_number: r.customer_licence_number,
                    source: 'rental'
                });
            }
        }
    });
    return Array.from(customerMap.values());
  }, [customers, rentals]);

  // === INITIALIZATION & DATA FETCHING ===
  
  useEffect(() => {
    const fetchData = async () => {
      try {
        const [customersResponse, rentalsResponse] = await Promise.all([
          supabase.from('app_4c3a7a6153_customers').select('*'),
          supabase.from('app_4c3a7a6153_rentals').select('*').order('created_at', { ascending: false }),
        ]);

        if (customersResponse.data) setCustomers(customersResponse.data);
        if (rentalsResponse.data) setRentals(rentalsResponse.data);
        console.log('[StepperRentalForm] Fetched initial customer and rental data.');
      } catch (err) {
        console.error("Failed to fetch initial data", err);
      }
    };

    fetchData();
    loadVehicleModels();
    loadTransportFees();
    
    const today = getMoroccoTodayString();
    setFormData(prev => ({
      ...prev,
      rental_start_date: prev.rental_start_date || today,
      rental_end_date: prev.rental_end_date || today,
    }));
  }, []);

  const loadVehicleModels = async () => {
    try {
      const models = await VehicleModelService.getAllVehicleModels();
      setVehicleModels(models);
      console.log('ðŸš— Vehicle models loaded for pricing lookup:', models);
    } catch (err) {
      console.error('Error loading vehicle models:', err);
    }
  };

  const loadTransportFees = async () => {
    try {
      const fees = await AppSettingsService.getTransportFees();
      setTransportFees(fees);
      console.log('ðŸšš Transport fees loaded:', fees);
    } catch (err) {
      console.error('Error loading transport fees:', err);
    }
  };

  // === FORM INITIALIZATION ===
  
  useEffect(() => {
    if (initialData) {
      isProgrammaticChange.current = true;
      
      let startTime = '';
      let endTime = '';
      
      if (initialData.rental_start_at) {
        const startDate = new Date(initialData.rental_start_at);
        if (!isNaN(startDate.getTime())) {
            startTime = startDate.toTimeString().slice(0, 5);
        }
      }
      
      if (initialData.rental_end_at) {
        const endDate = new Date(initialData.rental_end_at);
        if (!isNaN(endDate.getTime())) {
            endTime = endDate.toTimeString().slice(0, 5);
        }
      }

      const cleanStartDate = initialData.rental_start_date ? initialData.rental_start_date.split('T')[0] : '';
      const cleanEndDate = initialData.rental_end_date ? initialData.rental_end_date.split('T')[0] : '';
      
      setFormData({
        customer_name: initialData.customer_name || '',
        customer_email: initialData.customer_email || '',
        customer_phone: initialData.customer_phone || '',
        customer_id: initialData.customer_id || null,
        vehicle_id: initialData.vehicle_id || '',
        rental_start_date: cleanStartDate,
        rental_end_date: cleanEndDate,
        rental_start_time: startTime,
        rental_end_time: endTime,
        rental_type: initialData.rental_type || 'daily',
        rental_status: initialData.rental_status || 'scheduled',
        payment_status: initialData.payment_status || 'unpaid',
        total_amount: initialData.total_amount || 0,
        pickup_location: initialData.pickup_location || 'Office',
        dropoff_location: initialData.dropoff_location || 'Office',
        quantity_days: initialData.quantity_days || 0,
        unit_price: initialData.unit_price || 0,
        transport_fee: initialData.transport_fee || 0,
        pickup_transport: initialData.pickup_transport || false,
        dropoff_transport: initialData.dropoff_transport || false,
        deposit_amount: initialData.deposit_amount || 0,
        damage_deposit: initialData.damage_deposit || 0,
        remaining_amount: initialData.remaining_amount || 0,
        customer_licence_number: initialData.customer_licence_number || '',
        customer_id_number: initialData.customer_id_number || '',
        customer_dob: initialData.customer_dob || '',
        customer_place_of_birth: initialData.customer_place_of_birth || '',
        customer_nationality: initialData.customer_nationality || '',
        customer_issue_date: initialData.customer_issue_date || '',
        contract_signed: initialData.contract_signed || false,
        insurance_included: initialData.insurance_included !== undefined ? initialData.insurance_included : true,
        helmet_included: initialData.helmet_included !== undefined ? initialData.helmet_included : true,
        gear_included: initialData.gear_included || false,
        accessories: initialData.accessories || '',
        signature_url: initialData.signature_url || null,
        second_driver_name: initialData.second_driver_name || '',
        second_driver_license: initialData.second_driver_license || '',
        second_driver_id_image: initialData.second_driver_id_image || null,
        customer_id_image: initialData.customer_id_image || null,
        approval_status: initialData.approval_status || 'auto',
        pending_total_request: initialData.pending_total_request || null
      });
    }
  }, [initialData]);

  // === AUTOMATION HOOKS from AvailabilityAwareRentalForm ===
  
  // 1. Date/time validation hook - EXACT COPY
  useEffect(() => {
    if (formData.rental_start_date && formData.rental_end_date && formData.rental_start_time && formData.rental_end_time) {
      const startDatetime = composeDateTime(formData.rental_start_date, formData.rental_start_time);
      const endDatetime = composeDateTime(formData.rental_end_date, formData.rental_end_time);

      if (startDatetime && endDatetime && startDatetime >= endDatetime) {
        console.warn('BIDIRECTIONAL_VALIDATION: Start date/time is on or after end date/time. Auto-correcting start time...');
        
        let newStartDatetime = new Date(endDatetime);
        
        if (formData.rental_type === 'hourly') {
          newStartDatetime.setHours(newStartDatetime.getHours() - 1);
        } else {
          newStartDatetime.setDate(newStartDatetime.getDate() - 1);
        }

        const newStartDate = formatDateToYYYYMMDD(newStartDatetime);
        const newStartTime = newStartDatetime.toTimeString().slice(0, 5);

        if (formData.rental_start_date !== newStartDate || formData.rental_start_time !== newStartTime) {
            setFormData(prev => ({
              ...prev,
              rental_start_date: newStartDate,
              rental_start_time: newStartTime,
            }));
            setDateError("Start time was automatically adjusted to be before the end time.");
            return; 
        }
      } else {
        setDateError(null);
      }
    }
    calculateQuantityAndPricing();
  }, [
    formData.rental_start_date, 
    formData.rental_end_date,
    formData.rental_start_time,
    formData.rental_end_time,
    formData.rental_type,
    formData.vehicle_id
  ]);

  // 2. Transport fee calculation hook - EXACT COPY
  useEffect(() => {
    calculateTransportFee();
  }, [formData.pickup_transport, formData.dropoff_transport, transportFees]);

  // 3. Financial calculation hook - EXACT COPY
  useEffect(() => {
    calculateFinancials();
  }, [formData.quantity_days, formData.unit_price, formData.transport_fee, formData.deposit_amount]);

  // 4. Payment status auto-update hook - EXACT COPY
  useEffect(() => {
    if (isManualStatusChange.current) {
      return;
    }
    const deposit = parseFloat(formData.deposit_amount) || 0;
    const total = parseFloat(formData.total_amount) || 0;
    const currentStatus = formData.payment_status;

    if (currentStatus === 'overdue') {
      return;
    }
    
    let newPaymentStatus;
    if (total > 0) {
        if (deposit <= 0) {
            newPaymentStatus = 'unpaid';
        } else if (deposit >= total) {
            newPaymentStatus = 'paid';
        } else {
            newPaymentStatus = 'partial';
        }
    } else {
        newPaymentStatus = 'unpaid';
    }

    if (newPaymentStatus !== currentStatus) {
      console.log(`ðŸ”„ Auto-updating payment status from "${currentStatus}" to "${newPaymentStatus}" based on deposit: ${deposit} and total: ${total}.`);
      setFormData(prev => ({
        ...prev,
        payment_status: newPaymentStatus
      }));
    }
  }, [formData.deposit_amount, formData.total_amount, formData.payment_status]);

  // 5. Unit price auto-population hook - EXACT COPY
  useEffect(() => {
    if (formData.vehicle_id && formData.rental_type) {
      console.log('ðŸ”„ Auto-populating unit price for:', { 
        vehicle_id: formData.vehicle_id, 
        rental_type: formData.rental_type 
      });
      autoPopulateUnitPrice();
    } else if (!formData.vehicle_id) {
      console.log('ðŸ”„ No vehicle selected, clearing unit price');
      setFormData(prev => ({
        ...prev,
        unit_price: 0
      }));
      setAutoCalculatedPrice(0);
    }
  }, [formData.vehicle_id, formData.rental_type]);

  // 6. Hourly rental time auto-update hook - EXACT COPY
  useEffect(() => {
    if (formData.rental_type === 'hourly' && formData.rental_start_time) {
      console.log('â° Hourly rental start time changed, auto-updating end time...');
      handleQuickHourSelect(1);
    }
  }, [formData.rental_start_time, formData.rental_type]);

  // 7. Customer auto-population hook - EXACT COPY
  useEffect(() => {
    if (isProgrammaticChange.current && formData.customer_name) {
      const customerData = getAggregatedCustomerData();
      const searchName = formData.customer_name.trim().toLowerCase();
      const match = customerData.find(c => c.name.trim().toLowerCase() === searchName);

      if (match) {
        console.log('ðŸ¤– Found automatic match for customer:', match);
        setFormData(prev => ({
          ...prev,
          customer_email: prev.customer_email || match.email || '',
          customer_phone: prev.customer_phone || match.phone || '',
          customer_id: prev.customer_id || match.id || null,
        }));
      }
      isProgrammaticChange.current = false;
    }
  }, [formData.customer_name, getAggregatedCustomerData]);

  // Handle clicks outside suggestions dropdown
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (customerSearchRef.current && !customerSearchRef.current.contains(event.target)) {
        setShowSuggestions(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  // === EVENT HANDLERS ===
  
  const handleInputChange = (field, value) => {
    console.log('ðŸ“ HandleInputChange called:', { field, value });

    if (field === 'payment_status') {
      isManualStatusChange.current = true;
    }

    if (field === 'customer_phone') setIsPhoneDirty(true);
    if (field === 'customer_email') setIsEmailDirty(true);

    const newFormData = { ...formData, [field]: value };

    if (field === 'rental_type') {
      console.log('ðŸ“… RENTAL TYPE CHANGED TO:', value);
      const todayStr = getMoroccoTodayString();
      const currentTime = new Date().toTimeString().slice(0, 5);
      
      newFormData.rental_type = value;

      let startDateToUse = newFormData.rental_start_date || todayStr;
      if (startDateToUse && startDateToUse.includes('T')) {
        startDateToUse = startDateToUse.split('T')[0];
      }

      if (value === 'hourly') {
        newFormData.rental_start_date = startDateToUse;
        newFormData.rental_end_date = startDateToUse;
        const { startTime, endTime } = getMoroccoHourlyTimes();
        newFormData.rental_start_time = startTime;
        newFormData.rental_end_time = endTime;
      } else if (value === 'daily') {
        const tomorrowStr = getMoroccoDateOffset(1, startDateToUse);
        newFormData.rental_start_date = startDateToUse;
        newFormData.rental_end_date = tomorrowStr;
        newFormData.rental_start_time = currentTime;
        newFormData.rental_end_time = currentTime;
      } else if (value === 'weekly') {
        const weekLaterStr = getMoroccoDateOffset(7, startDateToUse);
        newFormData.rental_start_date = startDateToUse;
        newFormData.rental_end_date = weekLaterStr;
        newFormData.rental_start_time = currentTime;
        newFormData.rental_end_time = currentTime;
      }
    }

    if (field === 'rental_start_date') {
      let dateValue = value;
      if (dateValue && dateValue.includes('T')) {
        dateValue = dateValue.split('T')[0];
      }
      if (newFormData.rental_type === 'daily') {
        const nextDay = getMoroccoDateOffset(1, dateValue);
        newFormData.rental_end_date = nextDay;
      } else if (newFormData.rental_type === 'weekly') {
        const weekLater = getMoroccoDateOffset(7, dateValue);
        newFormData.rental_end_date = weekLater;
      } else if (newFormData.rental_type === 'hourly') {
        newFormData.rental_end_date = dateValue;
      }
      newFormData.rental_start_date = dateValue;
    }

    if (field === 'customer_name') {
      isProgrammaticChange.current = false;
      setFormData(newFormData);

      if (value.length >= 2) {
        const customerData = getAggregatedCustomerData();
        const trimmedName = value.trim().toLowerCase();
        const filteredSuggestions = customerData.filter(suggestion => 
          suggestion.name.trim().toLowerCase().includes(trimmedName)
        );
        setSuggestions(filteredSuggestions);
        setShowSuggestions(filteredSuggestions.length > 0);
      } else {
        setSuggestions([]);
        setShowSuggestions(false);
      }
      return;
    }

    setFormData(newFormData);

    if (errors[field]) {
      setErrors(prev => ({ ...prev, [field]: '' }));
    }
  };

  const handleSuggestionClick = (suggestion) => {
    console.log('--- DEBUG: SELECTED CUSTOMER OBJECT ---');
    console.log(JSON.stringify(suggestion, null, 2));
    console.log('------------------------------------');
    isProgrammaticChange.current = false;
    setFormData(prev => ({
      ...prev,
      customer_name: suggestion.name,
      customer_email: !isEmailDirty ? suggestion.email || '' : prev.customer_email,
      customer_phone: !isPhoneDirty ? suggestion.phone || '' : prev.customer_phone,
      customer_licence_number: suggestion.licence_number || '',
      customer_id: suggestion.id || null,
    }));
    setSuggestions([]);
    setShowSuggestions(false);
  };

  const handleVehicleChange = (vehicleId) => {
    console.log('ðŸš— Vehicle selection changed to:', vehicleId);
    setFormData(prev => ({
      ...prev,
      vehicle_id: vehicleId,
      unit_price: vehicleId ? prev.unit_price : 0
    }));

    setAvailabilityStatus('unknown');
    setAvailabilityDetails(null);
  };

  const handleDateChange = (field, value) => {
    console.log('ðŸ“… Date change:', field, value);
    
    let cleanValue = value;
    if (value && value.includes('T')) {
      cleanValue = value.split('T')[0];
    }

    const newValues = {};
    newValues[field === 'startDate' ? 'rental_start_date' : 'rental_end_date'] = cleanValue;

    if (field === 'startDate') {
      if (formData.rental_type === 'hourly') {
        newValues.rental_end_date = cleanValue;
      } else if (formData.rental_type === 'daily') {
        newValues.rental_end_date = getMoroccoDateOffset(1, cleanValue);
      } else if (formData.rental_type === 'weekly') {
        newValues.rental_end_date = getMoroccoDateOffset(7, cleanValue);
      }
    }
    
    setFormData(prev => ({ ...prev, ...newValues }));
    setAvailabilityStatus('unknown');
    setAvailabilityDetails(null);
  };

  const handleQuickHourSelect = (hours) => {
    if (formData.rental_start_date && formData.rental_start_time) {
      console.log(`ðŸš€ Quick select: Adding ${hours} hours to start time.`);
      const startDatetime = composeDateTime(formData.rental_start_date, formData.rental_start_time);
      
      if (startDatetime) {
        const endDatetime = new Date(startDatetime.getTime() + hours * 60 * 60 * 1000);
        
        const newEndDate = formatDateToYYYYMMDD(endDatetime);
        const newEndTime = endDatetime.toTimeString().slice(0, 5);

        setFormData(prev => ({
          ...prev,
          rental_end_date: newEndDate,
          rental_end_time: newEndTime,
        }));
        
        console.log(`âœ… End time updated to: ${newEndDate} ${newEndTime}`);
      }
    } else {
      console.warn('âš ï¸ Cannot quick-select hours without a start date and time.');
      setErrors({ general: 'Please set a start date and time first.' });
    }
  };

  const handleQuickDaySelect = (days) => {
    if (formData.rental_start_date) {
      console.log(`ðŸš€ Quick select: Adding ${days} days to start date.`);
      const newEndDate = getMoroccoDateOffset(days, formData.rental_start_date);
      
      setFormData(prev => ({
        ...prev,
        rental_end_date: newEndDate,
      }));
      
      console.log(`âœ… End date updated to: ${newEndDate}`);
    } else {
      console.warn('âš ï¸ Cannot quick-select days without a start date.');
      setErrors({ general: 'Please set a start date first.' });
    }
  };

  const handleIDScanComplete = async (ocrData) => {
    console.log("ðŸ”„ [StepperForm] ID Scan completed with OCR data:", ocrData);
    setScannedCustomerData(ocrData);
    
    try {
      let customerData = ocrData;
      const customerId = ocrData.id || ocrData.customer_id;
      
      if (customerId) {
        console.log('ðŸ” Fetching complete customer data from database for ID:', customerId);
        const fetchResult = await enhancedUnifiedCustomerService.getCustomerById(customerId);
        
        if (fetchResult.success && fetchResult.data) {
          customerData = fetchResult.data;
          console.log('âœ… Complete customer data fetched:', customerData);
        } else {
          console.warn('âš ï¸ Could not fetch complete customer data, using OCR data');
        }
      }
      
      isProgrammaticChange.current = true;
      setFormData(prev => ({
        ...prev,
        customer_name: prev.customer_name || customerData.full_name || customerData.customer_name || customerData.raw_name || prev.customer_name,
        customer_email: prev.customer_email || customerData.email || customerData.customer_email || prev.customer_email,
        customer_phone: prev.customer_phone || customerData.phone || customerData.customer_phone || prev.customer_phone,
        customer_id: prev.customer_id || customerData.id || customerData.customer_id,
        customer_licence_number: prev.customer_licence_number || customerData.licence_number || customerData.document_number || prev.customer_licence_number,
        customer_id_number: prev.customer_id_number || customerData.id_number || customerData.document_number || prev.customer_id_number,
        customer_dob: prev.customer_dob || customerData.date_of_birth || prev.customer_dob,
        customer_place_of_birth: prev.customer_place_of_birth || customerData.place_of_birth || prev.customer_place_of_birth,
        customer_nationality: prev.customer_nationality || customerData.nationality || prev.customer_nationality,
        customer_issue_date: prev.customer_issue_date || customerData.issue_date || prev.customer_issue_date
      }));
      
      setShowIDScanModal(false);
      setSuccess('âœ… Customer information updated from ID scan!');
      
      setTimeout(() => {
        setSuccess(null);
      }, 5000);
      
    } catch (error) {
      console.error('âŒ Error handling ID scan:', error);
      setErrors({ general: `Failed to process ID scan: ${error.message}` });
    }
  };

  // === VALIDATION ===
  
  const validateStep = (step) => {
    const newErrors = {};
    
    if (step === 1) {
      if (!formData.customer_name.trim()) newErrors.customer_name = 'Customer name is required';
      if (!formData.customer_phone.trim()) newErrors.customer_phone = 'Phone is required';
      
      if (formData.customer_email && formData.customer_email.trim()) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.customer_email.trim())) {
          newErrors.customer_email = 'Please enter a valid email address';
        }
      }
    } else if (step === 2) {
      if (!formData.vehicle_id) newErrors.vehicle_id = 'Vehicle selection is required';
      if (!formData.rental_start_date) newErrors.rental_start_date = 'Start date is required';
      if (!formData.rental_end_date) newErrors.rental_end_date = 'End date is required';
      
      if (formData.rental_start_date && formData.rental_end_date) {
        const start = composeDateTime(formData.rental_start_date, formData.rental_start_time);
        const end = composeDateTime(formData.rental_end_date, formData.rental_end_time);
        if (start && end && start >= end) {
          newErrors.rental_end_date = 'End date must be after start date';
        }
      }
    } else if (step === 3) {
      if (!formData.unit_price || formData.unit_price <= 0) newErrors.unit_price = 'Unit price is required';
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleNext = () => {
    if (validateStep(currentStep)) {
      setCurrentStep(prev => Math.min(prev + 1, 3));
    }
  };

  const handleBack = () => {
    setCurrentStep(prev => Math.max(prev - 1, 1));
  };

  // === FORM SUBMISSION with GATEKEEPER LOGIC ===
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    setSubmitting(true);
    setErrors({});
    setSuccess(null);

    try {
      console.log('ðŸš€ [StepperForm] Starting submission...');
      
      const currentTime = new Date().toTimeString().slice(0, 5);
      const submissionReadyFormData = { ...formData };
      
      // CRITICAL FIX: Remove problematic fields BEFORE spreading into submissionData
      delete submissionReadyFormData.status;
      delete submissionReadyFormData.linked_display_id;
      delete submissionReadyFormData.booking_range;
      delete submissionReadyFormData.vehicle;
      
      console.log('ðŸ§¹ Cleaned submissionReadyFormData, removed: status, linked_display_id, booking_range, vehicle');
      
      if (!submissionReadyFormData.rental_start_time) {
        submissionReadyFormData.rental_start_time = currentTime;
      }
      if (!submissionReadyFormData.rental_end_time) {
        submissionReadyFormData.rental_end_time = currentTime;
      }

      if (!submissionReadyFormData.customer_name || !submissionReadyFormData.customer_phone || 
          !submissionReadyFormData.vehicle_id || !submissionReadyFormData.rental_start_date || 
          !submissionReadyFormData.rental_end_date) {
        throw new Error('Please fill in all required fields: Customer name, phone, vehicle, start date, and end date.');
      }

      if (dateError) {
        throw new Error(dateError);
      }

      const trimmedEmail = (submissionReadyFormData.customer_email || '').trim();
      const emailToSubmit = trimmedEmail.length > 0 ? trimmedEmail : null;

      if (trimmedEmail.length > 0) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(trimmedEmail)) {
          throw new Error('Please enter a valid email address or leave the email field empty.');
        }
      }

      let finalCustomerId = submissionReadyFormData.customer_id;
      
      if (!finalCustomerId) {
        console.log('ðŸ†• Creating new customer record...');
        const newCustomerId = generateCustomerId();
        
        const newCustomerData = {
          id: newCustomerId,
          full_name: submissionReadyFormData.customer_name,
          phone: submissionReadyFormData.customer_phone,
          email: emailToSubmit,
          licence_number: submissionReadyFormData.customer_licence_number || null,
          id_number: submissionReadyFormData.customer_id_number || null,
          date_of_birth: submissionReadyFormData.customer_dob || null,
          nationality: submissionReadyFormData.customer_nationality || null,
          address: null,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        
        const saveResult = await enhancedUnifiedCustomerService.saveCustomer(newCustomerData);
        
        if (saveResult.success) {
          finalCustomerId = newCustomerId;
          console.log('âœ… Created new customer:', finalCustomerId);
        } else {
          throw new Error(`Failed to create new customer: ${saveResult.error}`);
        }
      }

      console.log('ðŸ›¡ï¸ GATEKEEPER: Checking for price override...');
      const userRole = userProfile?.role;
      const manualPrice = parseFloat(submissionReadyFormData.unit_price) || 0;
      const autoPrice = parseFloat(autoCalculatedPrice) || 0;
      const isPriceOverride = manualPrice !== autoPrice;
      const isStaff = userRole === 'employee' || userRole === 'guide';

      console.log('ðŸ›¡ï¸ GATEKEEPER: Price comparison:', {
        manualPrice,
        autoPrice,
        isPriceOverride,
        userRole,
        isStaff
      });

      const submissionData = {
        ...submissionReadyFormData,
        customer_id: finalCustomerId,
        customer_phone: submissionReadyFormData.customer_phone,
        customer_email: emailToSubmit,
        vehicle_id: submissionReadyFormData.vehicle_id ? Number(submissionReadyFormData.vehicle_id) : null,
        quantity_days: Number(submissionReadyFormData.quantity_days) || 0,
        unit_price: Number(submissionReadyFormData.unit_price) || 0,
        transport_fee: Number(submissionReadyFormData.transport_fee) || 0,
        total_amount: Number(submissionReadyFormData.total_amount) || 0,
        deposit_amount: Number(submissionReadyFormData.deposit_amount) || 0,
        damage_deposit: Number(submissionReadyFormData.damage_deposit) || 0,
        remaining_amount: Number(submissionReadyFormData.remaining_amount) || 0,
        rental_status: submissionReadyFormData.rental_status || 'scheduled',
        payment_status: submissionReadyFormData.payment_status || 'unpaid',
        rental_start_at: composeDateTime(submissionReadyFormData.rental_start_date, submissionReadyFormData.rental_start_time)?.toISOString(),
        rental_end_at: composeDateTime(submissionReadyFormData.rental_end_date, submissionReadyFormData.rental_end_time)?.toISOString(),
        accessories: submissionReadyFormData.accessories || null,
        customer_licence_number: submissionReadyFormData.customer_licence_number || null,
        customer_id_number: submissionReadyFormData.customer_id_number || null,
        customer_dob: submissionReadyFormData.customer_dob || null,
        customer_place_of_birth: submissionReadyFormData.customer_place_of_birth || null,
        customer_nationality: submissionReadyFormData.customer_nationality || null,
        customer_issue_date: submissionReadyFormData.customer_issue_date || null,
        signature_url: submissionReadyFormData.signature_url || null,
      };

      if (isStaff && isPriceOverride) {
        console.log('ðŸ›¡ï¸ GATEKEEPER: Staff price override detected! Setting pending approval status...');
        
        const originalSubtotal = (submissionData.quantity_days || 0) * autoPrice;
        const originalTotal = originalSubtotal + (submissionData.transport_fee || 0);
        
        submissionData.approval_status = 'pending';
        submissionData.pending_total_request = submissionData.total_amount;
        submissionData.total_amount = originalTotal;
        submissionData.remaining_amount = originalTotal - (submissionData.deposit_amount || 0);
        
        console.log('ðŸ›¡ï¸ GATEKEEPER: Approval data set:', {
          approval_status: 'pending',
          pending_total_request: submissionData.pending_total_request,
          original_total_amount: originalTotal
        });

        try {
          const notificationCount = await sendWhatsAppNotifications(submissionData.pending_total_request);
          
          if (notificationCount > 0) {
            console.log(`ðŸ“± WHATSAPP: Successfully notified ${notificationCount} admin(s)`);
            toast.success(`ðŸ“± WhatsApp notifications sent to ${notificationCount} admin(s)`);
          } else {
            console.log('ðŸ“± WHATSAPP: No admins were notified');
            toast.info('âš ï¸ No admins with WhatsApp enabled found. Approval request saved.');
          }
        } catch (whatsappError) {
          console.error('ðŸ“± WHATSAPP: Error sending notifications:', whatsappError);
          toast.warning('âš ï¸ Approval request saved, but WhatsApp notifications failed');
        }

      } else if (userRole === 'admin' || userRole === 'owner') {
        console.log('ðŸ›¡ï¸ GATEKEEPER: Admin/Owner bypass - setting auto approval status');
        submissionData.approval_status = 'auto';
        submissionData.pending_total_request = null;
      } else {
        console.log('ðŸ›¡ï¸ GATEKEEPER: No price override or non-staff user - setting auto approval status');
        submissionData.approval_status = 'auto';
        submissionData.pending_total_request = null;
      }

      console.log('ðŸ“¦ Final Submission Payload:', submissionData);
      
      const result = await TransactionalRentalService.createRentalWithTransaction(submissionData);
      
      if (result && result.success) {
        let successMessage = 'âœ… Rental successfully created!';
        
        if (submissionData.approval_status === 'pending') {
          successMessage += ' â³ Price override submitted for admin approval.';
        }
        
        setSuccess(successMessage);
        console.log('âœ… Rental operation successful:', result.data);

        setTimeout(() => {
          if (onSubmit) onSubmit(result.data);
        }, 1500);
      } else {
        throw new Error(result?.error || 'Unknown rental service error.');
      }
      
    } catch (err) {
      console.error('âŒ Submission Error:', err);
      
      let errorMessage = err.message || 'An unexpected error occurred during rental creation.';
      
      if (err.message && (err.message.includes('Vehicle availability check failed') || 
                          err.message.includes('Vehicle is not available'))) {
        setAvailabilityStatus('conflict');
        
        const match = err.message.match(/Next available:\s*(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2})/);
        let suggestionContent;
        
        if (match) {
          const formattedTime = new Date(match[1]).toLocaleString('en-GB', {
            day: 'numeric',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          suggestionContent = `Try booking after: ${formattedTime}`;
        } else {
          suggestionContent = 'Please check the availability calendar or select a different vehicle.';
        }
        
        setErrors({ 
          general: `ðŸš« Vehicle Scheduling Conflict: ${err.message}`,
          suggestion: suggestionContent
        });
        return;
      }
      
      setErrors({ general: errorMessage });
      
    } finally {
      setSubmitting(false);
    }
  };

  // Helper functions for datetime composition
  const getComposedStartDateTime = () => {
    const datetime = composeDateTime(formData.rental_start_date, formData.rental_start_time);
    return datetime ? datetime.toISOString() : null;
  };

  const getComposedEndDateTime = () => {
    const datetime = composeDateTime(formData.rental_end_date, formData.rental_end_time);
    return datetime ? datetime.toISOString() : null;
  };

  // Steps definition
  const steps = [
    { number: 1, title: 'Customer & ID', icon: User, description: 'Enter customer information' },
    { number: 2, title: 'Vehicle & Dates', icon: Car, description: 'Select vehicle and rental period' },
    { number: 3, title: 'Review & Payment', icon: CreditCardIcon, description: 'Review details and complete payment' }
  ];

  return (
    <div className="max-w-6xl mx-auto p-4 sm:p-6">
      {/* Progress Stepper */}
      <div className="mb-8">
        <div className="flex items-center justify-between mb-2">
          {steps.map((step, index) => (
            <React.Fragment key={step.number}>
              <div className="flex flex-col items-center flex-1">
                <div className={`w-10 h-10 sm:w-12 sm:h-12 rounded-full flex items-center justify-center font-semibold transition-all ${
                  currentStep > step.number
                    ? 'bg-green-500 text-white'
                    : currentStep === step.number
                    ? 'bg-blue-600 text-white ring-4 ring-blue-200'
                    : 'bg-gray-200 text-gray-500'
                }`}>
                  {currentStep > step.number ? (
                    <Check className="w-5 h-5 sm:w-6 sm:h-6" />
                  ) : (
                    <step.icon className="w-5 h-5 sm:w-6 sm:h-6" />
                  )}
                </div>
                <span className={`text-xs sm:text-sm mt-2 text-center font-medium ${
                  currentStep >= step.number ? 'text-gray-900' : 'text-gray-400'
                }`}>
                  {step.title}
                </span>
                <span className="text-xs text-gray-500 mt-1 text-center hidden sm:block">
                  {step.description}
                </span>
              </div>
              {index < steps.length - 1 && (
                <div className={`flex-1 h-1 mx-2 transition-all ${
                  currentStep > step.number ? 'bg-green-500' : 'bg-gray-200'
                }`} />
              )}
            </React.Fragment>
          ))}
        </div>
      </div>

      {/* Success Message */}
      {success && (
        <div className="mb-6 p-4 bg-green-50 border border-green-200 rounded-md">
          <div className="flex">
            <div className="flex-shrink-0">
              <Check className="h-5 w-5 text-green-400" />
            </div>
            <div className="ml-3">
              <p className="text-sm font-medium text-green-800">{success}</p>
            </div>
          </div>
        </div>
      )}

      {/* Error Message */}
      {errors.general && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
          <div className="flex">
            <div className="flex-shrink-0">
              <AlertCircle className="h-5 w-5 text-red-400" />
            </div>
            <div className="ml-3 w-full">
              <h3 className="text-sm font-medium text-red-800">Rental Creation Failed</h3>
              <div className="text-sm text-red-700 mt-1 whitespace-pre-line w-full">
                {errors.general}
              </div>
              {errors.suggestion && (
                <div className="mt-2 p-2 bg-white rounded border border-red-200 text-sm">
                  <span className="font-semibold text-gray-700">Suggestion:</span>
                  <br />
                  {errors.suggestion}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {dateError && (
        <div className="mb-6 p-4 bg-red-50 border-l-4 border-red-500">
          <p className="text-red-700">{dateError}</p>
        </div>
      )}

      {/* Form Content */}
      <form onSubmit={handleSubmit} className="bg-white rounded-lg shadow-lg p-4 sm:p-6">
        {/* Step 1: Customer & ID Scan */}
        {currentStep === 1 && (
          <div className="space-y-6">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-xl sm:text-2xl font-bold text-gray-900">Customer Information</h2>
              <button
                type="button"
                onClick={() => setShowIDScanModal(true)}
                className="flex items-center gap-2 px-3 py-2 sm:px-4 sm:py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm sm:text-base"
                disabled={submitting}
              >
                <Scan className="w-4 h-4 sm:w-5 sm:h-5" />
                <span className="hidden sm:inline">Scan ID</span>
                <span className="sm:hidden">Scan</span>
              </button>
            </div>

            <div className="space-y-4">
              <div className="relative" ref={customerSearchRef}>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Customer Name *
                </label>
                <input
                  type="text"
                  value={formData.customer_name}
                  onChange={(e) => handleInputChange('customer_name', e.target.value)}
                  placeholder="Enter customer name"
                  autoComplete="off"
                  className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                    errors.customer_name ? 'border-red-500' : 'border-gray-300'
                  }`}
                  disabled={submitting}
                />
                {showSuggestions && suggestions.length > 0 && (
                  <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                    <ul>
                      {suggestions.map((suggestion, index) => (
                        <li
                          key={index}
                          onClick={() => handleSuggestionClick(suggestion)}
                          className="px-4 py-2 cursor-pointer hover:bg-blue-50"
                        >
                          <div className="flex items-center">
                            <UserSearch className="h-4 w-4 mr-2 text-gray-500" />
                            <div>
                              <p className="font-medium text-gray-800">{suggestion.name}</p>
                              <p className="text-sm text-gray-500">{suggestion.phone} - {suggestion.email}</p>
                            </div>
                          </div>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
                {errors.customer_name && !showSuggestions && (
                  <p className="text-red-500 text-xs mt-1">{errors.customer_name}</p>
                )}
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Phone *
                  </label>
                  <div className="relative">
                    <Phone className="absolute left-3 top-2.5 h-4 w-4 text-gray-400" />
                    <input
                      type="tel"
                      value={formData.customer_phone}
                      onChange={(e) => handleInputChange('customer_phone', e.target.value)}
                      placeholder="+212-XXX-XXX-XXX"
                      className={`w-full px-3 py-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.customer_phone ? 'border-red-500' : 'border-gray-300'
                      }`}
                      disabled={submitting}
                    />
                  </div>
                  {errors.customer_phone && (
                    <p className="text-red-500 text-xs mt-1">{errors.customer_phone}</p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Email
                  </label>
                  <div className="relative">
                    <Mail className="absolute left-3 top-2.5 h-4 w-4 text-gray-400" />
                    <input
                      type="email"
                      value={formData.customer_email}
                      onChange={(e) => handleInputChange('customer_email', e.target.value)}
                      placeholder="customer@email.com"
                      className={`w-full px-3 py-2 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.customer_email ? 'border-red-500' : 'border-gray-300'
                      }`}
                      disabled={submitting}
                    />
                  </div>
                  {errors.customer_email && (
                    <p className="text-red-500 text-xs mt-1">{errors.customer_email}</p>
                  )}
                  <p className="text-xs text-gray-500 mt-1">Optional field - can be left empty</p>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  License Number
                </label>
                <input
                  type="text"
                  value={formData.customer_licence_number}
                  onChange={(e) => handleInputChange('customer_licence_number', e.target.value)}
                  placeholder="Will be populated by ID scan"
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50"
                  disabled={submitting}
                />
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Second Driver Name
                  </label>
                  <input
                    type="text"
                    value={formData.second_driver_name}
                    onChange={(e) => handleInputChange('second_driver_name', e.target.value)}
                    placeholder="Optional"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    disabled={submitting}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Second Driver License
                  </label>
                  <input
                    type="text"
                    value={formData.second_driver_license}
                    onChange={(e) => handleInputChange('second_driver_license', e.target.value)}
                    placeholder="Optional"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    disabled={submitting}
                  />
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Step 2: Vehicle & Time */}
        {currentStep === 2 && (
          <div className="space-y-6">
            <h2 className="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Vehicle & Rental Period</h2>
            
            <div className="space-y-4">
              {/* Rental Type */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Rental Type *
                </label>
                <div className="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                  {[
                    { value: 'hourly', label: 'Hourly' },
                    { value: 'daily', label: 'Daily' },
                    { value: 'weekly', label: 'Weekly' }
                  ].map((option) => (
                    <button
                      key={option.value}
                      type="button"
                      onClick={() => handleInputChange('rental_type', option.value)}
                      className={`flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        formData.rental_type === option.value
                          ? 'bg-blue-600 text-white shadow-sm'
                          : 'text-gray-700 hover:text-gray-900 hover:bg-gray-200'
                      }`}
                      disabled={submitting}
                    >
                      {option.label}
                    </button>
                  ))}
                </div>
                {formData.rental_type === 'hourly' && (
                  <p className="text-xs text-purple-600 mt-2">
                    â° Time fields auto-populated with Morocco local time + 30 minutes
                  </p>
                )}
              </div>

              {/* Vehicle Selector */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Select Vehicle *
                </label>
                <div className="bg-green-50 p-4 rounded-lg">
                  <SmartVehicleSelector
                    startDate={getComposedStartDateTime()}
                    endDate={getComposedEndDateTime()}
                    selectedVehicleId={formData.vehicle_id}
                    onVehicleChange={handleVehicleChange}
                    excludeRentalId={initialData?.id}
                    disabled={submitting}
                  />
                </div>
                {errors.vehicle_id && (
                  <p className="text-red-500 text-xs mt-1">{errors.vehicle_id}</p>
                )}
              </div>

              {/* Date Selection */}
              <div className="bg-green-50 p-4 rounded-lg">
                <h3 className="text-sm font-medium text-green-900 mb-2">
                  ðŸ“… Smart Date Selection
                </h3>
                {formData.rental_type === 'daily' && (
                  <div className="mb-4 flex space-x-1 bg-gray-100 p-1 rounded-lg">
                    {[1, 2, 3].map((day) => (
                      <button
                        key={day}
                        type="button"
                        onClick={() => handleQuickDaySelect(day)}
                        className="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-gray-700 hover:text-gray-900 hover:bg-gray-200 disabled:bg-gray-300 disabled:cursor-not-allowed"
                        disabled={!formData.rental_start_date || submitting}
                      >
                        {day} Day{day > 1 ? 's' : ''}
                      </button>
                    ))}
                  </div>
                )}
                <SmartDatePicker
                  selectedVehicleId={formData.vehicle_id}
                  startDate={formData.rental_start_date}
                  endDate={formData.rental_end_date}
                  onDateChange={handleDateChange}
                  rentalType={formData.rental_type}
                  disabled={submitting}
                  excludeRentalId={initialData?.id}
                />
                {errors.rental_start_date && (
                  <p className="text-red-500 text-xs mt-1">{errors.rental_start_date}</p>
                )}
                {errors.rental_end_date && (
                  <p className="text-red-500 text-xs mt-1">{errors.rental_end_date}</p>
                )}
              </div>

              {/* Time Selection for Hourly Rentals */}
              {formData.rental_type === 'hourly' && (
                <div className="bg-blue-50 p-4 rounded-lg">
                  <h3 className="text-sm font-medium text-blue-900 mb-2">
                    ðŸ• Time Selection
                  </h3>
                  <div className="mb-4 flex space-x-1 bg-gray-100 p-1 rounded-lg">
                    {[1, 2, 3].map((hour) => (
                      <button
                        key={hour}
                        type="button"
                        onClick={() => handleQuickHourSelect(hour)}
                        className="flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-gray-700 hover:text-gray-900 hover:bg-gray-200 disabled:bg-gray-300 disabled:cursor-not-allowed"
                        disabled={!formData.rental_start_time || submitting}
                      >
                        {hour} Hour{hour > 1 ? 's' : ''}
                      </button>
                    ))}
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Start Time
                      </label>
                      <div className="relative">
                        <input
                          type="time"
                          value={formData.rental_start_time || ""}
                          onChange={(e) => handleInputChange('rental_start_time', e.target.value)}
                          disabled={!formData.rental_start_date || submitting}
                          className="w-full px-3 py-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-50 disabled:text-gray-500"
                        />
                        <Clock className="absolute left-3 top-2.5 h-4 w-4 text-gray-400" />
                      </div>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        End Time
                      </label>
                      <div className="relative">
                        <input
                          type="time"
                          value={formData.rental_end_time || ""}
                          onChange={(e) => handleInputChange('rental_end_time', e.target.value)}
                          disabled={!formData.rental_end_date || submitting}
                          className="w-full px-3 py-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-50 disabled:text-gray-500"
                        />
                        <Clock className="absolute left-3 top-2.5 h-4 w-4 text-gray-400" />
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Transport Options */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-3">
                  Transport Options
                </label>
                <div className="flex flex-col gap-3">
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.pickup_transport}
                      onChange={(e) => handleInputChange('pickup_transport', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      disabled={submitting}
                    />
                    <span className="ml-2 text-sm text-gray-700">
                      Pick-up Transport 
                      {transportFees.pickup_fee > 0 && (
                        <span className="text-blue-600 font-medium ml-1">
                          (+{transportFees.pickup_fee.toFixed(2)} MAD)
                        </span>
                      )}
                    </span>
                  </label>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={formData.dropoff_transport}
                      onChange={(e) => handleInputChange('dropoff_transport', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                      disabled={submitting}
                    />
                    <span className="ml-2 text-sm text-gray-700">
                      Drop-off Transport
                      {transportFees.dropoff_fee > 0 && (
                        <span className="text-blue-600 font-medium ml-1">
                          (+{transportFees.dropoff_fee.toFixed(2)} MAD)
                        </span>
                      )}
                    </span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Step 3: Review & Payment */}
        {currentStep === 3 && (
          <div className="space-y-6">
            <h2 className="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Review & Payment</h2>
            
            {/* Summary Section */}
            <div className="bg-gray-50 rounded-lg p-4 space-y-3">
              <h3 className="font-semibold text-gray-900 mb-3">Rental Summary</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                <div>
                  <span className="text-gray-600">Customer:</span>
                  <p className="font-medium">{formData.customer_name}</p>
                </div>
                <div>
                  <span className="text-gray-600">Email:</span>
                  <p className="font-medium">{formData.customer_email || 'Not provided'}</p>
                </div>
                <div>
                  <span className="text-gray-600">Phone:</span>
                  <p className="font-medium">{formData.customer_phone}</p>
                </div>
                <div>
                  <span className="text-gray-600">License:</span>
                  <p className="font-medium">{formData.customer_licence_number || 'Not provided'}</p>
                </div>
                <div>
                  <span className="text-gray-600">Rental Type:</span>
                  <p className="font-medium capitalize">{formData.rental_type}</p>
                </div>
                <div>
                  <span className="text-gray-600">Duration:</span>
                  <p className="font-medium">
                    {formData.quantity_days} {formData.rental_type === 'hourly' ? 'Hours' : 
                                           formData.rental_type === 'weekly' ? 'Weeks' : 'Days'}
                  </p>
                </div>
                <div>
                  <span className="text-gray-600">Start:</span>
                  <p className="font-medium">
                    {formData.rental_start_date} {formData.rental_start_time && `at ${formData.rental_start_time}`}
                  </p>
                </div>
                <div>
                  <span className="text-gray-600">End:</span>
                  <p className="font-medium">
                    {formData.rental_end_date} {formData.rental_end_time && `at ${formData.rental_end_time}`}
                  </p>
                </div>
                <div>
                  <span className="text-gray-600">Pickup:</span>
                  <p className="font-medium">{formData.pickup_location}</p>
                </div>
                <div>
                  <span className="text-gray-600">Transport Fee:</span>
                  <p className="font-medium">{formData.transport_fee.toFixed(2)} MAD</p>
                </div>
              </div>
            </div>

            {/* Financial Section */}
            <div className="space-y-4">
              <h3 className="font-semibold text-gray-900">Financial Details</h3>
              
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Quantity ({formData.rental_type === 'hourly' ? 'Hours' : formData.rental_type === 'weekly' ? 'Weeks' : 'Days'})
                  </label>
                  <input
                    type="number"
                    value={formData.quantity_days || ""}
                    readOnly
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-green-50 focus:outline-none"
                    disabled={submitting}
                  />
                  <p className="text-xs text-green-600 mt-1">ðŸ—“ï¸ Auto-calculated from dates & times</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Unit Price (MAD) *
                  </label>
                  <input
                    type="number"
                    value={formData.unit_price || ""}
                    onChange={(e) => handleInputChange('unit_price', parseFloat(e.target.value) || 0)}
                    className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                      errors.unit_price ? 'border-red-500' : 'border-gray-300'
                    }`}
                    min="0"
                    step="0.01"
                    disabled={submitting}
                  />
                  {errors.unit_price && (
                    <p className="text-red-500 text-xs mt-1">{errors.unit_price}</p>
                  )}
                  <p className="text-xs text-blue-600 mt-1">
                    ðŸ’° {formData.vehicle_id 
                      ? 'Auto-populated from Database Pricing Rules' 
                      : 'Select a vehicle to auto-populate pricing'
                    }
                  </p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Transport Fee (MAD)
                  </label>
                  <div className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-blue-50 text-blue-700 font-medium">
                    {formData.transport_fee.toFixed(2)} MAD
                  </div>
                  <p className="text-xs text-blue-600 mt-1">ðŸšš Auto-calculated from selected transport options</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Total Amount (MAD)
                  </label>
                  <div className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-blue-50 text-blue-700 font-bold text-lg">
                    {formData.total_amount.toFixed(2)} MAD
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Payment Status *
                  </label>
                  <select
                    value={formData.payment_status}
                    onChange={(e) => handleInputChange('payment_status', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                    disabled={submitting}
                  >
                    <option value="unpaid">Unpaid</option>
                    <option value="partial">Partial</option>
                    <option value="paid">Paid</option>
                    <option value="overdue">Overdue</option>
                  </select>
                  <p className="text-xs text-green-600 mt-1">ðŸ’³ Auto-updates based on deposit amount</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Deposit Amount (MAD)
                  </label>
                  <input
                    type="number"
                    value={formData.deposit_amount || ""}
                    onChange={(e) => handleInputChange('deposit_amount', parseFloat(e.target.value) || 0)}
                    className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                      errors.deposit_amount ? 'border-red-500' : 'border-gray-300'
                    }`}
                    min="0"
                    step="0.01"
                    disabled={submitting}
                  />
                  {errors.deposit_amount && (
                    <p className="text-red-500 text-xs mt-1">{errors.deposit_amount}</p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Damage Deposit (MAD)
                  </label>
                  <input
                    type="number"
                    value={formData.damage_deposit || ""}
                    onChange={(e) => handleInputChange('damage_deposit', parseFloat(e.target.value) || 0)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    min="0"
                    step="0.01"
                    disabled={submitting}
                  />
                  <p className="text-xs text-blue-600 mt-1">âš ï¸ Refundable upon ATV return & inspection</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Remaining (MAD)
                  </label>
                  <div className={`w-full px-3 py-2 border border-gray-300 rounded-lg font-medium ${
                    formData.remaining_amount === 0 ? 'bg-green-50 text-green-700' : 'bg-gray-100 text-gray-700'
                  }`}>
                    {formData.remaining_amount.toFixed(2)} MAD
                  </div>
                </div>
              </div>
            </div>

            {/* Additional Options */}
            <div className="space-y-4">
              <h3 className="font-semibold text-gray-900">Additional Options</h3>
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="insurance_included"
                    checked={formData.insurance_included}
                    onChange={(e) => handleInputChange('insurance_included', e.target.checked)}
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    disabled={submitting}
                  />
                  <label htmlFor="insurance_included" className="ml-2 text-sm text-gray-700">
                    Insurance Included
                  </label>
                </div>
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="helmet_included"
                    checked={formData.helmet_included}
                    onChange={(e) => handleInputChange('helmet_included', e.target.checked)}
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    disabled={submitting}
                  />
                  <label htmlFor="helmet_included" className="ml-2 text-sm text-gray-700">
                    Helmet Included
                  </label>
                </div>
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="gear_included"
                    checked={formData.gear_included}
                    onChange={(e) => handleInputChange('gear_included', e.target.checked)}
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    disabled={submitting}
                  />
                  <label htmlFor="gear_included" className="ml-2 text-sm text-gray-700">
                    Gear Included
                  </label>
                </div>
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="contract_signed"
                    checked={formData.contract_signed}
                    onChange={(e) => handleInputChange('contract_signed', e.target.checked)}
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    disabled={submitting}
                  />
                  <label htmlFor="contract_signed" className="ml-2 text-sm text-gray-700">
                    Contract Signed
                  </label>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Navigation Buttons */}
        <div className="flex justify-between gap-3 pt-6 border-t mt-8">
          <button
            type="button"
            onClick={handleBack}
            disabled={currentStep === 1 || submitting}
            className="px-4 py-2 sm:px-6 sm:py-2 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base"
          >
            Back
          </button>
          
          {currentStep < 3 ? (
            <button
              type="button"
              onClick={handleNext}
              disabled={submitting}
              className="flex items-center gap-2 px-4 py-2 sm:px-6 sm:py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm sm:text-base"
            >
              Next
              <ChevronRight className="w-4 h-4 sm:w-5 sm:h-5" />
            </button>
          ) : (
            <button
              type="submit"
              disabled={submitting || isLoading}
              className="px-4 py-2 sm:px-6 sm:py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm sm:text-base font-semibold"
            >
              {submitting || isLoading ? (
                <>
                  <Loader className="animate-spin h-4 w-4 mr-2 inline" />
                  Creating...
                </>
              ) : (
                'Confirm & Create Rental'
              )}
            </button>
          )}
        </div>
      </form>

      {/* ID Scan Modal */}
      {showIDScanModal && (
        <EnhancedUnifiedIDScanModal
          isOpen={showIDScanModal}
          onClose={() => setShowIDScanModal(false)}
          onScanComplete={handleIDScanComplete}
        />
      )}
    </div>
  );
};

export default EnhancedStepperRentalForm;